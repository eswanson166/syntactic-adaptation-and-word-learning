---
title: "Syntactic Adaptation Children Analysis"
output: html_document
---

Load packages and set GG plot theme:
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(wesanderson)
source("helpers.R")
theme_set(theme_bw()) 
```

Read in data file:
```{r}
full_test_data = read.csv('../data/full_test_data.csv', stringsAsFactors = TRUE)
```

# Syntactic adaptaion analysis

Add information about when 'girls' starts:
```{r}
full_test_data <- full_test_data %>% mutate(frame_start = case_when(
  trial_audio == "dax" ~ 2016,
  trial_audio == "vash" ~ 1994,
  trial_audio == "smick" ~ 1987,
  trial_audio == "nup" ~ 1992))
```

Add info about when 'girls' ends:
```{r}
full_test_data <- full_test_data %>% mutate(frame_end = case_when(
  trial_audio == "dax" ~ 2497,
  trial_audio == "vash" ~ 2472,
  trial_audio == "smick" ~ 2485,
  trial_audio == "nup" ~ 2443))
```

Add info about when novel word ends:
```{r}
full_test_data <- full_test_data %>% mutate(novel_word_end = case_when(
  trial_audio == "ball" ~ 2828,
  trial_audio == "ball_filler" ~ 3239,
  trial_audio == "book" ~ 3142,
  trial_audio == "book_filler" ~ 3279,
  trial_audio == "box" ~ 3381,
  trial_audio == "box_filler" ~ 3386,
  trial_audio == "cry" ~ 3253,
  trial_audio == "cry_filler" ~ 3183,
  trial_audio == "dog" ~ 3240,
  trial_audio == "dog_filler" ~ 3352,
  trial_audio == "draw" ~ 3137,
  trial_audio == "draw_filler" ~ 2935,
  trial_audio == "drink" ~ 3116,
  trial_audio == "drink_filler" ~ 2881,
  trial_audio == "eat" ~ 3189,
  trial_audio == "eat_filler" ~ 2814,
  trial_audio == "dax" ~ 3354,
  trial_audio == "fep" ~ 3087,
  trial_audio == "hat" ~ 3205,
  trial_audio == "hat_filler" ~ 3409,
  trial_audio == "heth" ~ 3078,
  trial_audio == "horse" ~ 3276,
  trial_audio == "horse_filler" ~ 3459,
  trial_audio == "moop" ~ 2844,
  trial_audio == "nup" ~ 2996,
  trial_audio == "read" ~ 3279,
  trial_audio == "read_filler" ~ 3035,
  trial_audio == "shoe" ~ 3453,
  trial_audio == "shoe_filler" ~ 3136,
  trial_audio == "sit" ~ 3229,
  trial_audio == "sit_filler" ~ 2948,
  trial_audio == "sleep" ~ 3281,
  trial_audio == "sleep_filler" ~ 2991,
  trial_audio == "smick" ~ 3261,
  trial_audio == "vash" ~ 3275,
  trial_audio == "wave" ~ 3284,
  trial_audio == "wave_filler" ~ 2824
))
```

Add a column with time that the frame start occurs in the video:
```{r}
event_data = full_test_data %>% 
  mutate(trial_frame_start = trial_start_video + frame_start,
         one_look_length = look_end - look_start)
```

Add a column for current time since syntactic frame ('the girls') start:
```{r}
event_data = event_data %>% 
  mutate(time_since_frame_start = look_start - trial_frame_start)
```

Get mean times when "the girls" ends and the novel word ends.
```{r}
girls_end = mean(event_data$frame_end - event_data$frame_start)
novel_word_end = mean(event_data$novel_word_end - event_data$frame_start)
```

Remove trials where the child was not paying attention for more than half the trial:
```{r}
one_look_length = event_data$look_interval
event_data = event_data %>% group_by(subid, trial_no) %>%
  mutate(away_look_length = sum(look_dir == "away")*one_look_length) %>%
  filter(away_look_length < .5*(trial_end_video - trial_start_video))
```

Filter out only looks to the left or right side of the screen:
```{r}
event_data = event_data %>% filter(look_dir == "left" | look_dir == "right")
event_data$look_dir = factor(event_data$look_dir, levels = c("left", "right"))
```

Take out looks that come after the trial should have ended (likely while the next slide was loading):
```{r}
event_data = event_data %>% filter(time_since_frame_start <= 6000)
```

Add a column for proportion of looks to the action image on each test trial, and a column with each participant's mean proportion of looks across the four test trials (which will be useful for visualization). We will only examine proportion of looks to the action image, since the proportion of looks to the object image is simply 1 - (proportion of looks to the action image).
```{r}
event_data <- event_data %>% group_by(subid, trial_no) %>% 
  mutate(look_action_img = ifelse(look_dir == verb_image_position, TRUE, FALSE))
```

Separate the data into timebins.
```{r}
event_data_timecourse <- event_data %>% 
  mutate(timebin = plyr::round_any(time_since_frame_start, 50))
```

Summarise the time course data by trial.
```{r}
timecourse_sum_trial <- event_data_timecourse %>% 
  group_by(timebin, condition, trial_no) %>% 
  summarise(timebin_prop_action_look = mean(look_action_img)) %>%
  mutate(CI.Low = ci.low(unique(timebin_prop_action_look)),
          CI.High = ci.high(unique(timebin_prop_action_look))) %>%
  mutate(YMin = timebin_prop_action_look - CI.Low, 
         YMax = timebin_prop_action_look + CI.High)
```

Make the time course graph with separate trials.
```{r}
ggplot(timecourse_sum_trial) +
  aes(x = timebin, y = timebin_prop_action_look, color = condition) +
  geom_point(size = .2) +
  geom_smooth(size = .2) +
  facet_grid(trial_no ~ .) +
  ggtitle("Proportion of looks to action image on test trials") +
  xlab("Time since syntactic frame disambiguation (ms) during event phase") +
  ylab("Condition") +
  scale_color_manual(name="Condition", values = c(wes_palette("Royal1")[1], wes_palette("Royal1")[2], "dark blue")) +
  geom_hline(yintercept = .5, linetype = "dashed") +
  geom_vline(xintercept = 0) +
  ylim(c(0, 1)) +
  geom_errorbar(data = timecourse_sum_trial, aes(ymin = YMin, ymax = YMax), width = .25, position = position_dodge(width = 60), alpha = .4)
ggsave(file="../graphs/timecourse_trial_smooth.pdf",width=8,height=6)
```

Or collapse across trials:
```{r}
timecourse_sum <- event_data_timecourse %>% 
  group_by(timebin, condition) %>% 
  summarise(timebin_prop_action_look = mean(look_action_img)) %>%
  mutate(CI.Low = ci.low(unique(timebin_prop_action_look)),
          CI.High = ci.high(unique(timebin_prop_action_look))) %>%
  mutate(YMin = timebin_prop_action_look - CI.Low, 
         YMax = timebin_prop_action_look + CI.High)
```

Generate the graph collapsed across trials.
```{r}
ggplot(timecourse_sum) +
  aes(x = timebin, y = timebin_prop_action_look, color = condition) +
  geom_point(size = .8) +
  #geom_line(size = 2) +
  geom_smooth() +
  ggtitle("Proportion of looks to action image on test trials") +
  xlab("Time since start of syntactic frame (ms) during event phase") +
  ylab("Mean proportion of looks to action image") +
  scale_color_manual(name="Condition", values = c(wes_palette("Royal1")[1], wes_palette("Royal1")[2], "dark blue")) +
  geom_hline(yintercept = .5, linetype = "dashed") +
  geom_vline(xintercept = 0, color = "black") +
  ylim(c(0, 1)) +
  geom_vline(xintercept = girls_end, linetype = "dashed") +
  geom_vline(xintercept = novel_word_end, linetype= "dotted") +
  scale_x_continuous(breaks = seq(min(timecourse_sum$timebin), 
                                  max(timecourse_sum$timebin), by = 1000))
  #geom_errorbar(data = timecourse_sum_trial, aes(ymin = YMin, ymax = YMax), width = .25, position = position_dodge(width = 60), alpha = .4)
ggsave(file="../graphs/timecourse_overall_smooth.pdf",width=8,height=6)
```


## Proportion of looks

Take out looks after beginning of syntactic frame:
```{r}
event_data_disambig = event_data %>% filter(look_start >= trial_frame_start)
```

Calculate each subject's proportion looking to action image.
```{r}
event_data_disambig <- event_data_disambig %>% group_by(subid, trial_no) %>% 
  mutate(action_look_prop = mean(look_action_img))
```

Calculate each subject's average action image proportion looking time across test trials.
```{r}
event_data_disambig = event_data_disambig %>% group_by(subid) %>% 
  mutate(avg_action_look_prop = mean(action_look_prop))
```

Summarize average action image proportion looking time by condition.
```{r}
action_look_sum = event_data_disambig %>% group_by(subid) %>% 
  filter(row_number() == 1) %>% 
  group_by(condition) %>% 
  summarise(n = sum(!is.na(avg_action_look_prop)), 
            sd = sd(na.omit(avg_action_look_prop)),
            avg_action_look = mean(na.omit(avg_action_look_prop)),
            CI.Low = ci.low(na.omit(avg_action_look_prop)),
            CI.High = ci.high(na.omit(avg_action_look_prop)),
            n = n())  %>%
              mutate(YMin = avg_action_look - CI.Low, 
                     YMax = avg_action_look + CI.High)
```

Get a df with unique participants, and check condition and gender breakdown:
```{r}
unique_sub = event_data_disambig %>% group_by(subid) %>% filter(row_number() == 1)
unique_sub %>% group_by(condition) %>% summarise(n = n())
unique_sub %>% group_by(gender) %>% summarise(n = n())
```

Graph the proportion looking to action image.
```{r}
ggplot(action_look_sum) +
  aes(x = condition, y = avg_action_look, fill = condition) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "Condition",values = c(wes_palette("Royal1")[1], wes_palette("Royal1")[2], "dodgerblue3")) +
  ggtitle("Test trials: Participants' mean proportion of looks to action image") +
  xlab("Condition") +
  ylab("Mean proportion of looks") +
  geom_point(data = unique_sub, aes(x = condition, y = action_look_prop), shape = 21, size = .5) +
  geom_errorbar(data = action_look_sum, 
                aes(ymin = YMin, ymax = YMax), width = .25)
ggsave("../graphs/mean_prop_action_look.pdf", width = 6, height = 4)
```

Save updated data file:
```{r}
write.csv(event_data_disambig, "../data/full_test_data_for_analysis.csv")
```

